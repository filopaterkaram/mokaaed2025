<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مقاعد مسرح الواي (نيروز 2025)</title>
    <!-- Firebase App (الأساسية) -->
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>




    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        #bg-anim {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            pointer-events: none;
            opacity: 0.25;
            transition: opacity 0.5s;
        }
        :root {
            --main-bg: #fff;
            --main-color: #222;
            --section-bg: #f7f7f7;
            --section-title: #d4a900;
            --seat-bg: linear-gradient(135deg, #fffbe6 0%, #ffe066 100%);
            --seat-color: #222;
            --seat-hover-bg: linear-gradient(135deg, #ffe066 0%, #fffbe6 100%);
            --btn-bg: #ffd700;
            --btn-color: #222;
            --btn-hover-bg: #ffb347;
            --dark-bg: linear-gradient(135deg, #18191a 0%, #232526 100%);
            --dark-main-color: #eee;
            --dark-section-bg: rgba(40,40,40,0.7);
            --dark-section-title: #ffb347;
            --dark-seat-bg: linear-gradient(135deg, #444 0%, #222 100%);
            --dark-seat-color: #ffd700;
            --dark-seat-hover-bg: linear-gradient(135deg, #222 0%, #444 100%);
        }
        body {
            background: var(--main-bg);
            font-family: 'Cairo', Arial, sans-serif;
            color: var(--main-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: background 0.7s cubic-bezier(.4,2,.6,1), color 0.5s;
        }
        body.dark {
            background: var(--dark-bg);
            color: var(--dark-main-color);
        }
        h1, h2 {
            text-align: center;
            margin: 30px auto;
            letter-spacing: 1px;
            font-size: 2.2rem;
            transition: color 0.5s;
            z-index: 10;
            position: relative;
        }
        h2 {
            font-size: 1.8rem;
        }
        .sections {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        .section {
            background: var(--section-bg);
            border-radius: 18px;
            padding: 24px 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            min-width: 260px;
            transition: transform 0.3s, background 0.5s, box-shadow 0.3s;
            z-index: 5;
        }
        body.dark .section {
            background: var(--dark-section-bg);
        }
        .section:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 18px;
            text-align: center;
            letter-spacing: 1px;
            color: var(--section-title);
            transition: color 0.5s;
        }
        body.dark .section-title {
            color: var(--dark-section-title);
        }
        .seats {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }
        .seat {
            background: var(--seat-bg);
            color: var(--seat-color);
            border-radius: 8px;
            padding: 10px 8px;
            min-width: 60px;
            text-align: center;
            margin-bottom: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s, color 0.5s;
            position: relative;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        body.dark .seat {
            background: var(--dark-seat-bg);
            color: var(--dark-seat-color);
        }
        .seat:hover {
            background: var(--seat-hover-bg);
            transform: scale(1.07) rotate(-2deg);
        }
        body.dark .seat:hover {
            background: var(--dark-seat-hover-bg);
        }
        .seat .owner {
            display: block;
            font-size: 0.85em;
            color: #444;
            margin-top: 2px;
            font-weight: 400;
        }
        body.dark .seat .owner {
            color: #ffd700;
        }
        .icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: transform 0.25s, box-shadow 0.25s, background 0.3s, color 0.3s;
        }
        .icon-btn .icon {
            font-size: 1.4em;
        }
        .theme-toggle {
            position: fixed;
            left: 18px;
            top: 18px;
            z-index: 2000;
            background: #fff;
            color: #222;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            cursor: pointer;
            font-size: 1.7em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s, color 0.3s, transform 0.3s;
        }
        .theme-toggle:hover {
            background: #ffd700;
            color: #222;
            transform: scale(1.1) rotate(360deg);
        }
        .page {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
            position: relative;
            z-index: 10;
            padding: 20px;
            box-sizing: border-box;
        }
        #sidebar {
            position: fixed; right: 0; top: 0; height: 100vh; width: 70px;
            background: rgba(34,34,34,0.97); z-index: 3000;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 80px; gap: 10px;
            box-shadow: -2px 0 12px rgba(0,0,0,0.13);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(.6,-0.3,.3,1.3), width 0.35s;
        }
        #sidebar.sidebar-shown {
            transform: translateX(0);
        }
        #sidebar.sidebar-hidden {
            transform: translateX(100%);
        }
        #sidebar:hover {
            width: 220px;
        }
        #sidebar .sidebar-btn {
            width: 90%; min-width: 44px; height: 44px; display: flex;
            align-items: center; gap: 12px; justify-content: flex-start;
            background: none; border: none; color: #ffd700;
            font-size: 1.2em; border-radius: 8px; margin: 0 0 6px 0;
            cursor: pointer; padding: 0 10px; overflow: hidden;
            transition: background 0.2s, color 0.2s;
        }
        #sidebar .sidebar-btn .icon { font-size: 1.5em; min-width: 32px; text-align: center; }
        #sidebar .sidebar-label {
            opacity: 0; max-width: 0; white-space: nowrap; overflow: hidden;
            color: #ffd700; font-size: 1em; font-weight: bold;
            transition: opacity 0.3s 0.1s, max-width 0.3s 0.1s;
        }
        #sidebar:hover .sidebar-label { opacity: 1; max-width: 150px; margin-right: 8px; }
        #sidebar .sidebar-btn:hover { background: #ffd70033; color: #fff; }
        #sidebarToggleBtn {
            position:fixed; right:18px; top:18px; z-index:3500; background:#ffd700;
            color:#222; border:none; border-radius:10px; width:48px; height:48px;
            display:flex; align-items:center; justify-content:center; font-size:2em;
            box-shadow:0 2px 8px rgba(0,0,0,0.13); cursor:pointer;
            transition: background 0.3s, transform 0.3s;
        }
        #sidebarToggleBtn:hover { background: #ffb347; transform: scale(1.1); }
        #mainMenuPage > div {
            flex-direction: row !important; gap: 18px; justify-content: center;
            align-items: center; flex-wrap: wrap;
            animation: fadeInRight 0.7s cubic-bezier(.4,2,.6,1);
        }
        #mainMenuPage button.icon-btn:hover {
            transform: scale(1.08) rotate(-2deg);
            box-shadow: 0 6px 24px #ffd70055;
            background: #fffbe6 !important; color: #222 !important;
        }
        @keyframes fadeInRight {
            from { opacity:0; transform:translateX(60px); }
            to { opacity:1; transform:translateX(0); }
        }
        @media print {
            body * { display: none !important; }
            #logTableContainer, #logTableContainer * { display: block !important; }
        }
        
        /* إدارة الكراسي */
        .seat-management {
            display: flex;
            gap: 18px;
            margin-bottom: 18px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .seat-management div {
            background: rgba(255,255,255,0.1);
            padding: 12px;
            border-radius: 8px;
        }
        .seat-management button {
            background: #ffd700;
            color: #222;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            font-weight: bold;
            cursor: pointer;
            margin: 0 4px;
        }
        .seat-management button.remove {
            background: #b00;
            color: #fff;
        }
        .seat-table {
            width: 100%;
            max-width: 800px;
            border-collapse: collapse;
            direction: rtl;
            background: rgba(255,255,255,0.07);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 18px;
        }
        .seat-table th {
            background: #ffd700;
            color: #222;
            font-weight: bold;
            padding: 8px;
        }
        .seat-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .seat-table tr:last-child td {
            border-bottom: none;
        }
        .deleteSeatBtn {
            background: #b00;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 4px 10px;
            cursor: pointer;
        }
        
        /* نماذج الإدخال */
        .form-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
            margin-bottom: 18px;
            background: rgba(255,255,255,0.05);
            padding: 18px;
            border-radius: 12px;
        }
        .form-container input, 
        .form-container select, 
        .form-container button {
            padding: 8px;
            border-radius: 6px;
            border: none;
            font-size: 1em;
        }
        .form-container button {
            background: var(--btn-bg);
            color: var(--btn-color);
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        .form-container button:hover {
            background: var(--btn-hover-bg);
        }
        
        /* نتائج البحث */
        .result-container {
            width: 100%;
            max-width: 800px;
            min-height: 40px;
            margin-bottom: 18px;
        }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            direction: rtl;
        }
        .result-table th {
            background: #ffd700;
            color: #222;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #ccc;
        }
        .result-table td {
            padding: 8px;
            border: 1px solid #ccc;
        }
        
        /* نافذة السجل */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            color: #222;
            border-radius: 12px;
            padding: 24px 18px;
            min-width: 320px;
            max-width: 90vw;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-close {
            position: absolute;
            left: 12px;
            top: 12px;
            background: #ffd700;
            color: #333;
            border: none;
            border-radius: 6px;
            padding: 4px 14px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* حجم الخط */
        body.font-small { font-size: 13px; }
        body.font-medium { font-size: 16px; }
        body.font-large { font-size: 20px; }
        
        @media (max-width: 900px) {
            #mainMenuPage > div { flex-direction: column !important; }
            .sections { flex-direction: column; align-items: center; gap: 24px; }
            .seat-management { flex-direction: column; align-items: center; }
        }
        @media (max-width: 700px) {
            #sidebar { width: 54px; }
            #sidebar .sidebar-btn { width:36px; height:36px; font-size:1.3em; }
        }
    </style>
</head>
<body>
    <canvas id="bg-anim"></canvas>

    <button id="themeToggleBtn" class="theme-toggle" title="تبديل الثيم"><span id="themeIcon">🌙</span></button>
    <button id="sidebarToggleBtn">
        <svg viewBox="0 0 32 32" width="28" height="28"><rect y="5" width="32" height="4" rx="2" fill="currentColor"/><rect y="14" width="32" height="4" rx="2" fill="currentColor"/><rect y="23" width="32" height="4" rx="2" fill="currentColor"/></svg>
    </button>
    
    <div id="sidebar" class="sidebar-hidden">
        <button class="sidebar-btn" id="sidebarMenuBtn" title="لوحة التحكم"><span class="icon">🏠</span><span class="sidebar-label">لوحة التحكم</span></button>
        <button class="sidebar-btn" id="sidebarSeatsBtn" title="إدارة الكراسي"><span class="icon">🪑</span><span class="sidebar-label">إدارة الكراسي</span></button>
        <button class="sidebar-btn" id="sidebarBookingBtn" title="الحجوزات"><span class="icon">🎟️</span><span class="sidebar-label">الحجوزات</span></button>
        <button class="sidebar-btn" id="sidebarTicketsBtn" title="بيع التذاكر"><span class="icon">🪪</span><span class="sidebar-label">بيع التذاكر</span></button>
        <button class="sidebar-btn" id="sidebarInquiryBtn" title="استعلامات"><span class="icon">🔍</span><span class="sidebar-label">استعلامات</span></button>
        <button class="sidebar-btn" id="sidebarAttendanceBtn" title="الحضور/الانصراف"><span class="icon">🕒</span><span class="sidebar-label">الحضور/الانصراف</span></button>
        <button class="sidebar-btn" id="sidebarAdminBtn" title="الإدارة"><span class="icon">⚙️</span><span class="sidebar-label">الإدارة</span></button>
        <div style="flex:1"></div>
        <button class="sidebar-btn" id="sidebarLogoutBtn" title="تسجيل الخروج"><span class="icon">🚪</span><span class="sidebar-label">تسجيل الخروج</span></button>
    </div>

    <div id="loginPage" class="page" style="display: flex;">
        <h1>تسجيل الدخول</h1>
        <form id="loginForm" style="display: flex; flex-direction: column; gap: 12px; min-width: 260px;">
            <input type="text" id="usernameInput" placeholder="اسم المستخدم" required style="padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1.1em;">
            <input type="password" id="passwordInput" placeholder="كلمة المرور" required style="padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1.1em;">
            <button type="submit" class="icon-btn" style="background: #ffd700; color: #333;">دخول</button>
            <div id="loginError" style="color: #ff4444; text-align: center; display: none; margin-top: 10px;">بيانات الدخول غير صحيحة</div>
        </form>
    </div>

    <div id="mainMenuPage" class="page">
        <h1>لوحة التحكم</h1>
        <div style="display:flex; flex-direction:column; gap:18px; margin:40px 0; min-width:260px;">
            <button id="goSeatManageBtn" class="icon-btn" style="background:#ffd700; color:#333;"><span class="icon">🪑</span> إدارة الكراسي</button>
            <button id="goBookingBtn" class="icon-btn" style="background:#ffd700; color:#333;"><span class="icon">🎟️</span> إدارة الحجوزات</button>
            <button id="goInquiryBtn" class="icon-btn" style="background:#ffb347; color:#333;"><span class="icon">🔍</span> استعلامات المقاعد</button>
            <button id="goTicketsBtn" class="icon-btn" style="background:#ffd700; color:#333;"><span class="icon">🪪</span> بيع تذاكر</button>
            <button id="goAttendanceBtn" class="icon-btn" style="background:#ffb347; color:#333;"><span class="icon">🕒</span> دخول/انصراف الأفراد</button>
            <button id="goAdminBtn" class="icon-btn" style="background:#222; color:#ffd700;"><span class="icon">⚙️</span> الإدارة</button>
        </div>
        <button id="logoutBtnMainMenu" class="icon-btn" style="background: #444; color: #fff; padding: 10px 20px;">تسجيل الخروج</button>
    </div>

    <div id="sectionSelectPage" class="page">
        <h1>اختر القسم</h1>
        <div id="sectionBtns" style="display: flex; gap: 24px; margin: 32px 0;"></div>
        <button id="backToMenuFromSectionSelect" class="icon-btn" style="background: #444; color: #fff; margin-top: 20px;">رجوع للقائمة</button>
    </div>

    <div id="mainPage" class="page">
        <h1 id="mainTitle"></h1>
        <button id="showLogBtn" class="icon-btn" style="background: #ffd700; color: #333; margin-bottom: 18px;"><span class="icon">📋</span> سجل الكراسي</button>
        <div class="sections" id="sections"></div>
        <form id="addSeatForm" class="form-container">
            <input type="number" id="seatNumber" placeholder="رقم الكرسي" min="1" required>
            <input type="text" id="ownerName" placeholder="اسم صاحب الكرسي" required>
            <input type="text" id="mobileNumber" placeholder="رقم الموبايل" required pattern="[0-9]+" title="رقم الموبايل">
            <button type="submit" class="icon-btn"><span class="icon">➕</span> إضافة كرسي</button>
        </form>
        <div style="display: flex; justify-content: center; gap: 16px; margin-top: 18px;">
            <button id="backToSectionsBtn" class="icon-btn" style="background: #444; color: #fff;">رجوع لاختيار القسم</button>
        </div>
    </div>
    
    <!-- نافذة سجل الكراسي -->
    <div id="logModal" class="modal">
        <div class="modal-content">
            <button id="closeLogBtn" class="modal-close">إغلاق</button>
            <h2>سجل الكراسي المحجوزة</h2>
            <div id="logTableContainer"></div>
            <button id="exportPdfBtn" class="icon-btn" style="background: #ffd700; color: #333; margin: 18px auto 0; display: block;">تصدير PDF</button>
        </div>
    </div>
    
    <div id="adminPage" class="page">
        <h1><span class="icon">⚙️</span> لوحة الإدارة</h1>
        <form id="addUserForm" class="form-container">
            <input type="text" id="newUsername" placeholder="اسم المستخدم الجديد" required>
            <input type="password" id="newPassword" placeholder="كلمة المرور" required>
            <div id="adminSectionsCheckboxes" style="display:flex; gap:10px; color: var(--dark-main-color);"></div>
            <div id="adminPermissionsCheckboxes" style="display:flex; flex-wrap:wrap; gap:10px; color: var(--dark-main-color); margin-top:8px;"></div>
            <button type="submit" class="icon-btn"><span class="icon">➕</span> إضافة مستخدم</button>
        </form>
        <div id="usersTableContainer" style="width:100%; max-width:800px; margin-bottom:18px;"></div>
        <button id="backToMenuFromAdmin" class="icon-btn" style="background: #444; color: #fff; margin-top:18px;"><span class="icon">🏠</span> رجوع للقائمة</button>
    </div>

    <div id="seatManagePage" class="page">
        <h1>إدارة الكراسي</h1>
        <div class="seat-management">
            <div>
                <span style="font-weight:bold;">قسم A:</span>
                <button id="addSeatA">➕ كرسي</button>
                <button id="removeSeatA" class="remove">➖ كرسي</button>
                <span id="countA"></span>
            </div>
            <div>
                <span style="font-weight:bold;">قسم B:</span>
                <button id="addSeatB">➕ كرسي</button>
                <button id="removeSeatB" class="remove">➖ كرسي</button>
                <span id="countB"></span>
            </div>
            <div>
                <span style="font-weight:bold;">قسم C:</span>
                <button id="addSeatC">➕ كرسي</button>
                <button id="removeSeatC" class="remove">➖ كرسي</button>
                <span id="countC"></span>
            </div>
        </div>
        <form id="addSeatManualForm" class="form-container" style="flex-direction: row; flex-wrap: wrap;">
            <input type="number" id="manualSeatNumber" placeholder="رقم الكرسي" min="1" max="20" required>
            <input type="text" id="manualOwnerName" placeholder="اسم صاحب الكرسي" required>
            <input type="text" id="manualMobileNumber" placeholder="رقم الموبايل" required pattern="[0-9]+" title="رقم الموبايل">
            <select id="manualSection" required>
                <option value="">اختر القسم</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
            <button type="submit">إضافة كرسي</button>
        </form>
        <div id="seatManageTableContainer" class="result-container"></div>
        <button id="exportSeatsPdfBtn" class="icon-btn" style="background: #ffd700; color: #333; margin-bottom: 12px;">تصدير PDF</button>
        <button id="backToMenuFromSeats" class="icon-btn" style="background: #444; color: #fff;">رجوع للقائمة</button>
    </div>
    
    <div id="inquiryPage" class="page">
        <h1>استعلام عن مقعد أو شخص</h1>
        <form id="inquiryForm" class="form-container" style="flex-direction: row; flex-wrap: wrap;">
            <input type="text" id="inquiryInput" placeholder="رقم الكرسي أو اسم أو موبايل">
            <button type="submit">بحث</button>
        </form>
        <div id="inquiryResult" class="result-container"></div>
        <button id="backToMenuFromInquiry" class="icon-btn" style="background: #444; color: #fff; margin-top:18px;">رجوع للقائمة</button>
    </div>
    
    <div id="ticketsPage" class="page">
        <h1>بيع التذاكر</h1>
        <form id="sellTicketForm" class="form-container">
            <input type="text" id="ticketBuyerName" placeholder="اسم المشتري" required>
            <input type="text" id="ticketBuyerMobile" placeholder="رقم الموبايل" required>
            <select id="ticketSection" required>
                <option value="">اختر القسم</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
            <select id="ticketSeatNumber" required>
                <option value="">اختر رقم الكرسي</option>
            </select>
            <button type="submit">بيع تذكرة</button>
        </form>
        <div id="ticketResult" class="result-container"></div>
        <button id="backToMenuFromTickets" class="icon-btn" style="background: #444; color: #fff; margin-top:18px;">رجوع للقائمة</button>
    </div>
    
    <div id="attendancePage" class="page">
        <h1>تسجيل دخول/انصراف الأفراد</h1>
        <form id="attendanceForm" class="form-container" style="flex-direction: row; flex-wrap: wrap;">
            <input type="text" id="attendanceName" placeholder="اسم الشخص أو رقم الموبايل">
            <button type="submit">تسجيل دخول/انصراف</button>
        </form>
        <div id="attendanceResult" class="result-container"></div>
        <button id="backToMenuFromAttendance" class="icon-btn" style="background: #444; color: #fff; margin-top:18px;">رجوع للقائمة</button>
    </div>

    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3V2v_T5tnkEzGI6EcfxO_lJo-diY9nG4",
      authDomain: "mokaaed2025.firebaseapp.com",
      databaseURL: "https://mokaaed2025-default-rtdb.firebaseio.com",
      projectId: "mokaaed2025",
      storageBucket: "mokaaed2025.firebasestorage.app",
      messagingSenderId: "731507668899",
      appId: "1:731507668899:web:4f450332344d0bcb638c16",
      measurementId: "G-8DHVLLJ5GP"
    };
    firebase.initializeApp(firebaseConfig);
    document.addEventListener('DOMContentLoaded', () => {
        firebase.database().ref("chairs").once("value").then(snapshot => {
  const allChairs = snapshot.val();
  if (allChairs) {
    Object.keys(allChairs).forEach(seatId => {
      const data = allChairs[seatId];
      const seatElement = document.getElementById(seatId);
      if (data.status === "reserved" && seatElement) {
        seatElement.classList.add("reserved");
        seatElement.style.pointerEvents = "none"; // يمنع الحجز مرة أخرى
      }
    });
  }
});

        // ===================================
        // Animated Background Logic
        // ===================================
        const canvas = document.getElementById('bg-anim');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;

        class Particle {
            constructor(x, y, directionX, directionY, size) {
                this.x = x; this.y = y; this.directionX = directionX;
                this.directionY = directionY; this.size = size;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
                ctx.fillStyle = document.body.classList.contains('dark') ? '#ffd700' : '#444444';
                ctx.fill();
            }
            update() {
                if (this.x > canvas.width || this.x < 0) { this.directionX = -this.directionX; }
                if (this.y > canvas.height || this.y < 0) { this.directionY = -this.directionY; }
                this.x += this.directionX;
                this.y += this.directionY;
                this.draw();
            }
        }

        function init() {
            particlesArray = [];
            let numberOfParticles = (canvas.height * canvas.width) / 11000;
            for (let i = 0; i < numberOfParticles; i++) {
                let size = (Math.random() * 1.5) + 1;
                let x = (Math.random() * ((innerWidth - size * 2) - (size * 2)) + size * 2);
                let y = (Math.random() * ((innerHeight - size * 2) - (size * 2)) + size * 2);
                let directionX = (Math.random() * .4) - 0.2;
                let directionY = (Math.random() * .4) - 0.2;
                particlesArray.push(new Particle(x, y, directionX, directionY, size));
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0,0,innerWidth, innerHeight);
            for (let i = 0; i < particlesArray.length; i++) { particlesArray[i].update(); }
        }

        window.addEventListener('resize', () => {
            canvas.width = innerWidth;
            canvas.height = innerHeight;
            init();
        });
        
        init();
        animate();

        // ===================================
        // App Core Logic
        // ===================================

        // Page Elements
        const pages = document.querySelectorAll('.page');
        const loginPage = document.getElementById('loginPage');
        const mainMenuPage = document.getElementById('mainMenuPage');
        const sectionSelectPage = document.getElementById('sectionSelectPage');
        const mainPage = document.getElementById('mainPage');
        const adminPage = document.getElementById('adminPage');
        const seatManagePage = document.getElementById('seatManagePage');
        const inquiryPage = document.getElementById('inquiryPage');
        const ticketsPage = document.getElementById('ticketsPage');
        const attendancePage = document.getElementById('attendancePage');
        const logModal = document.getElementById('logModal');

        // --- Theme ---
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const themeIcon = document.getElementById('themeIcon');
        function setTheme(mode) {
            if (mode === 'dark') {
                document.body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeIcon.textContent = '☀️';
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                themeIcon.textContent = '🌙';
            }
            // Redraw canvas with new color
            init();
        }
        themeToggleBtn.onclick = () => setTheme(document.body.classList.contains('dark') ? 'light' : 'dark');
        setTheme(localStorage.getItem('theme') || 'light');

        // --- Sidebar ---
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebar = document.getElementById('sidebar');
        sidebarToggleBtn.onclick = () => {
            sidebar.classList.toggle('sidebar-shown');
            sidebar.classList.toggle('sidebar-hidden');
        };
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.innerWidth < 700) {
                    sidebar.classList.remove('sidebar-shown');
                    sidebar.classList.add('sidebar-hidden');
                }
            });
        });

        // --- Data ---
        const USERS = {
            'filo': { password: '123', section: ['A', 'B', 'C'], permissions: ['booking', 'tickets', 'inquiry', 'attendance', 'admin', 'seat_manage'] },
            'userb': { password: 'bpass', section: ['B'], permissions: ['booking', 'inquiry'] },
        };
        const PERMISSIONS = [
            { key: 'booking', label: 'إدارة الحجوزات' },
            { key: 'tickets', label: 'بيع التذاكر' },
            { key: 'inquiry', label: 'الاستعلامات' },
            { key: 'attendance', label: 'الحضور/الانصراف' },
            { key: 'admin', label: 'الإدارة' },
            { key: 'seat_manage', label: 'إدارة الكراسي' }
        ];
        
        // بيانات الكراسي لكل قسم
        const seatsData = {
            A: Array.from({length: 20}, (_, i) => ({ number: i + 1, owner: '', mobile: '', bookedAt: '', leftAt: '' })),
            B: Array.from({length: 20}, (_, i) => ({ number: i + 1, owner: '', mobile: '', bookedAt: '', leftAt: '' })),
            C: Array.from({length: 20}, (_, i) => ({ number: i + 1, owner: '', mobile: '', bookedAt: '', leftAt: '' })),
        };
        
        let currentUser = null;
        let currentSection = null;
        let ticketSerial = 1;
        const soldTickets = [];
        const attendanceLog = [];

        // --- Navigation ---
        function hideAllPages() {
            pages.forEach(p => p.style.display = 'none');
        }

        function showPage(page) {
            hideAllPages();
            page.style.display = 'flex';
        }

        // --- Login/Logout ---
        const loginForm = document.getElementById('loginForm');
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            if (USERS[username] && USERS[username].password === password) {
                currentUser = { username, ...USERS[username] };
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').style.display = 'none';
                updateMenuPermissions();
                showPage(mainMenuPage);
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function logout() {
            currentUser = null;
            currentSection = null;
            showPage(loginPage);
            sidebar.classList.remove('sidebar-shown');
            sidebar.classList.add('sidebar-hidden');
        }
        document.getElementById('logoutBtnMainMenu').addEventListener('click', logout);
        document.getElementById('sidebarLogoutBtn').addEventListener('click', logout);

        // --- Permissions ---
        function updateMenuPermissions() {
            if (!currentUser) return;
            const perms = currentUser.permissions;
            document.getElementById('goBookingBtn').style.display = perms.includes('booking') ? 'flex' : 'none';
            document.getElementById('goTicketsBtn').style.display = perms.includes('tickets') ? 'flex' : 'none';
            document.getElementById('goInquiryBtn').style.display = perms.includes('inquiry') ? 'flex' : 'none';
            document.getElementById('goAttendanceBtn').style.display = perms.includes('attendance') ? 'flex' : 'none';
            document.getElementById('goAdminBtn').style.display = perms.includes('admin') ? 'flex' : 'none';
            document.getElementById('goSeatManageBtn').style.display = perms.includes('seat_manage') ? 'flex' : 'none';
            
            // Sidebar buttons
            document.getElementById('sidebarBookingBtn').style.display = perms.includes('booking') ? 'flex' : 'none';
            document.getElementById('sidebarTicketsBtn').style.display = perms.includes('tickets') ? 'flex' : 'none';
            document.getElementById('sidebarInquiryBtn').style.display = perms.includes('inquiry') ? 'flex' : 'none';
            document.getElementById('sidebarAttendanceBtn').style.display = perms.includes('attendance') ? 'flex' : 'none';
            document.getElementById('sidebarAdminBtn').style.display = perms.includes('admin') ? 'flex' : 'none';
            document.getElementById('sidebarSeatsBtn').style.display = perms.includes('seat_manage') ? 'flex' : 'none';
        }

        // --- Page Navigation Listeners ---
        // Main Menu Buttons
        document.getElementById('goBookingBtn').onclick = () => {
            showPage(sectionSelectPage);
            renderSectionButtons();
        };
        document.getElementById('goAdminBtn').onclick = () => {
            showPage(adminPage);
            renderAdminCheckboxes();
            renderUsersTable();
        };
        document.getElementById('goSeatManageBtn').onclick = () => {
            showPage(seatManagePage);
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('goInquiryBtn').onclick = () => {
            showPage(inquiryPage);
            document.getElementById('inquiryInput').value = '';
            document.getElementById('inquiryResult').innerHTML = '';
        };
        document.getElementById('goTicketsBtn').onclick = () => {
            showPage(ticketsPage);
            document.getElementById('sellTicketForm').reset();
            document.getElementById('ticketResult').innerHTML = '';
            document.getElementById('ticketSeatNumber').innerHTML = '<option value="">اختر رقم الكرسي</option>';
        };
        document.getElementById('goAttendanceBtn').onclick = () => {
            showPage(attendancePage);
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceResult').innerHTML = '';
        };
        
        // Sidebar Buttons
        document.getElementById('sidebarMenuBtn').onclick = () => showPage(mainMenuPage);
        document.getElementById('sidebarBookingBtn').onclick = () => {
            showPage(sectionSelectPage);
            renderSectionButtons();
        };
        document.getElementById('sidebarAdminBtn').onclick = () => {
            showPage(adminPage);
            renderAdminCheckboxes();
            renderUsersTable();
        };
        document.getElementById('sidebarSeatsBtn').onclick = () => {
            showPage(seatManagePage);
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('sidebarInquiryBtn').onclick = () => {
            showPage(inquiryPage);
            document.getElementById('inquiryInput').value = '';
            document.getElementById('inquiryResult').innerHTML = '';
        };
        document.getElementById('sidebarTicketsBtn').onclick = () => {
            showPage(ticketsPage);
            document.getElementById('sellTicketForm').reset();
            document.getElementById('ticketResult').innerHTML = '';
            document.getElementById('ticketSeatNumber').innerHTML = '<option value="">اختر رقم الكرسي</option>';
        };
        document.getElementById('sidebarAttendanceBtn').onclick = () => {
            showPage(attendancePage);
            document.getElementById('attendanceForm').reset();
            document.getElementById('attendanceResult').innerHTML = '';
        };

        // Back Buttons
        document.querySelectorAll('[id^="backToMenuFrom"]').forEach(btn => {
            btn.onclick = () => showPage(mainMenuPage);
        });
        document.getElementById('backToSectionsBtn').onclick = () => showPage(sectionSelectPage);
        
        // --- Section Selection ---
        function renderSectionButtons() {
            const sectionBtns = document.getElementById('sectionBtns');
            sectionBtns.innerHTML = '';
            if (!currentUser) return;
            
            const sections = Array.isArray(currentUser.section) ? currentUser.section : [currentUser.section];
            sections.forEach(sec => {
                const btn = document.createElement('button');
                btn.className = 'icon-btn';
                btn.setAttribute('data-section', sec);
                btn.innerHTML = `<span class="icon">${sec}</span> القسم ${sec}`;
                btn.style.background = '#ffd700';
                btn.style.color = '#333';
                sectionBtns.appendChild(btn);
                
                btn.onclick = () => {
                    currentSection = sec;
                    showPage(mainPage);
                    document.getElementById('mainTitle').textContent = `مقاعد المسرح - القسم ${currentSection}`;
                    renderSection(currentSection);
                };
            });
        }
        
        // --- Seat Management ---
        function updateSeatCounts() {
            document.getElementById('countA').textContent = `(${seatsData.A.length} كرسي)`;
            document.getElementById('countB').textContent = `(${seatsData.B.length} كرسي)`;
            document.getElementById('countC').textContent = `(${seatsData.C.length} كرسي)`;
        }
        // تحميل الكراسي من Firebase قبل عرض الجدول
firebase.database().ref("chairs").once("value").then(snapshot => {
  const data = snapshot.val();
  if (!data) return;

  // نفرّغ seatsData
  seatsData = { A: [], B: [], C: [] };

  // نوزّع الكراسي حسب القسم
  Object.keys(data).forEach(seatId => {
    const seat = data[seatId];
    const section = seat.section || 'A'; // أو B أو C
    seatsData[section].push({
      number: seatId,
      owner: seat.owner || '',
      mobile: seat.mobile || ''
    });
  });

  // عرض الجدول
  renderSeatManageTable();
});

        function renderSeatManageTable() {
            let html = '<table class="seat-table">';
            html += '<tr><th>القسم</th><th>رقم الكرسي</th><th>الاسم</th><th>الموبايل</th><th>حذف</th></tr>';
            ['A','B','C'].forEach(sec => {
                seatsData[sec].forEach(seat => {
                    html += `<tr>
                        <td>${sec}</td>
                        <td>${seat.number}</td>
                        <td>${seat.owner||''}</td>
                        <td>${seat.mobile||''}</td>
                        <td><button class='deleteSeatBtn' data-section='${sec}' data-number='${seat.number}'>🗑️</button></td>
                    </tr>`;
                });
            });
            html += '</table>';
            document.getElementById('seatManageTableContainer').innerHTML = html;
            
            document.querySelectorAll('.deleteSeatBtn').forEach(btn => {
                btn.onclick = function() {
                    const sec = this.getAttribute('data-section');
                    const num = parseInt(this.getAttribute('data-number'),10);
                    const seat = seatsData[sec][num-1];
                    if(!seat.owner) { alert('الكرسي غير محجوز'); return; }
                    if(confirm('هل تريد حذف بيانات هذا الكرسي؟')) {
                        seat.owner = '';
                        seat.mobile = '';
                        seat.bookedAt = '';
                        seat.leftAt = '';
                      firebase.database().ref("chairs").once("value").then(snapshot => {
  const data = snapshot.val();
  if (!data) return;

  seatsData = { A: [], B: [], C: [] };

  Object.keys(data).forEach(seatId => {
    const seat = data[seatId];
    const section = seat.section || 'A';
    seatsData[section].push({
      number: seatId,
      owner: seat.owner || '',
      mobile: seat.mobile || ''
    });
  });

  updateSeatCounts();
  renderSeatManageTable();
});

                    }
                };
            });
        }
        
        // Add/Remove Seats
        document.getElementById('addSeatA').onclick = function() {
            seatsData.A.push({ number: seatsData.A.length+1, owner: '', mobile: '', bookedAt: '', leftAt: '' });
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('removeSeatA').onclick = function() {
            if(seatsData.A.length<=1) return alert('يجب أن يبقى كرسي واحد على الأقل!');
            const last = seatsData.A[seatsData.A.length-1];
            if(last.owner) { if(!confirm('آخر كرسي محجوز، هل تريد حذفه؟')) return; }
            seatsData.A.pop();
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('addSeatB').onclick = function() {
            seatsData.B.push({ number: seatsData.B.length+1, owner: '', mobile: '', bookedAt: '', leftAt: '' });
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('removeSeatB').onclick = function() {
            if(seatsData.B.length<=1) return alert('يجب أن يبقى كرسي واحد على الأقل!');
            const last = seatsData.B[seatsData.B.length-1];
            if(last.owner) { if(!confirm('آخر كرسي محجوز، هل تريد حذفه؟')) return; }
            seatsData.B.pop();
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('addSeatC').onclick = function() {
            seatsData.C.push({ number: seatsData.C.length+1, owner: '', mobile: '', bookedAt: '', leftAt: '' });
            updateSeatCounts();
            renderSeatManageTable();
        };
        document.getElementById('removeSeatC').onclick = function() {
            if(seatsData.C.length<=1) return alert('يجب أن يبقى كرسي واحد على الأقل!');
            const last = seatsData.C[seatsData.C.length-1];
            if(last.owner) { if(!confirm('آخر كرسي محجوز، هل تريد حذفه؟')) return; }
            seatsData.C.pop();
            updateSeatCounts();
            renderSeatManageTable();
        };
        
        // Manual Seat Addition
        document.getElementById('addSeatManualForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const sec = document.getElementById('manualSection').value;
            const number = parseInt(document.getElementById('manualSeatNumber').value,10);
            const owner = document.getElementById('manualOwnerName').value.trim();
            const mobile = document.getElementById('manualMobileNumber').value.trim();
            if(!sec || !number || !owner || !mobile) return;
            if(number<1 || number>20) { alert('رقم الكرسي يجب أن يكون بين 1 و 20'); return; }
            const seat = seatsData[sec][number-1];
            if(seat.owner) { if(!confirm('هذا الكرسي له مالك بالفعل. هل تريد استبداله؟')) return; }
            seat.owner = owner;
            seat.mobile = mobile;
            seat.bookedAt = new Date().toLocaleString('ar-EG');
            seat.leftAt = '';
            renderSeatManageTable();
            this.reset();
        });
        
        // Export to PDF
        document.getElementById('exportSeatsPdfBtn').addEventListener('click', function() {
            loadJsPDF(() => exportAllSeatsToPDF());
        });
        
        function exportAllSeatsToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text('سجل جميع كراسي المسرح', doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            let y = 80;
            ['A','B','C'].forEach(sec => {
                doc.setFontSize(15);
                doc.setTextColor(80,80,80);
                doc.text(`القسم ${sec}`, 60, y);
                y += 20;
                doc.setFontSize(12);
                doc.setTextColor(0,0,0);
                doc.text('رقم الكرسي', 120, y);
                doc.text('الاسم', 220, y);
                doc.text('الموبايل', 320, y);
                y += 16;
                seatsData[sec].forEach(seat => {
                    doc.text(String(seat.number), 120, y);
                    doc.text(seat.owner||'', 220, y);
                    doc.text(seat.mobile||'', 320, y);
                    y += 14;
                });
                y += 10;
            });
            doc.save('سجل-جميع-الكراسي.pdf');
        }
        
        // --- Seat Management in Main Page ---
        function renderSection(section) {
            const sectionsDiv = document.getElementById('sections');
            sectionsDiv.innerHTML = '';
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'section';
            sectionDiv.innerHTML = `<div class="section-title">القسم ${section}</div>`;
            const seatsDiv = document.createElement('div');
            seatsDiv.className = 'seats';
            seatsData[section].forEach(seat => {
                const seatDiv = document.createElement('div');
                seatDiv.className = 'seat';
                seatDiv.innerHTML = `#${seat.number}` + (seat.owner ? `<span class="owner">${seat.owner}</span>` : '');
                if (seat.owner) {
                    seatDiv.style.cursor = 'pointer';
                    seatDiv.title = 'عرض بيانات الكرسي';
                    seatDiv.addEventListener('click', function() {
                        let info = `الكرسي رقم: ${seat.number}\nالاسم: ${seat.owner}\nالموبايل: ${seat.mobile}`;
                        if (seat.bookedAt) info += `\nوقت الحجز: ${seat.bookedAt}`;
                        if (seat.leftAt) info += `\nوقت الخروج: ${seat.leftAt}`;
                        info += '\n\nهل تريد إخراج صاحب الكرسي؟';
                        if (confirm(info)) {
                            seat.leftAt = new Date().toLocaleString('ar-EG');
                            seat.owner = '';
                            seat.mobile = '';
                            renderSection(section);
                        }
                    });
                }
                seatsDiv.appendChild(seatDiv);
            });
            sectionDiv.appendChild(seatsDiv);
            sectionsDiv.appendChild(sectionDiv);
        }
        
        // Add Seat in Main Page
        document.getElementById('addSeatForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!currentSection) return;
            const number = parseInt(document.getElementById('seatNumber').value, 10);
            const owner = document.getElementById('ownerName').value.trim();
            const mobile = document.getElementById('mobileNumber').value.trim();
            if (!owner || !number || !mobile) return;
            if (number < 1 || number > 20) {
                alert('رقم الكرسي يجب أن يكون بين 1 و 20');
                return;
            }
            const seat = seatsData[currentSection][number - 1];
            if (seat.owner) {
                if (!confirm('هذا الكرسي له مالك بالفعل. هل تريد استبدال المالك؟')) {
                    return;
                }
            }
            seat.owner = owner;
            seat.mobile = mobile;
            seat.bookedAt = new Date().toLocaleString('ar-EG');
            seat.leftAt = '';
            renderSection(currentSection);
            this.reset();
        });
        
        // --- Log Modal ---
        document.getElementById('showLogBtn').addEventListener('click', function() {
            if (!currentSection) return;
            const data = seatsData[currentSection].map(seat => seat).filter(seat => seat.owner || seat.bookedAt || seat.leftAt);
            if (data.length === 0) {
                document.getElementById('logTableContainer').innerHTML = '<div style="text-align:center; color:#b00;">لا يوجد بيانات لهذا القسم.</div>';
            } else {
                let table = '<table class="result-table">';
                table += '<tr><th>رقم الكرسي</th><th>الاسم</th><th>الموبايل</th><th>وقت الحجز</th><th>وقت الخروج</th></tr>';
                data.forEach(seat => {
                    table += `<tr>
                        <td>${seat.number}</td>
                        <td>${seat.owner}</td>
                        <td>${seat.mobile}</td>
                        <td>${seat.bookedAt || ''}</td>
                        <td>${seat.leftAt || ''}</td>
                    </tr>`;
                });
                table += '</table>';
                document.getElementById('logTableContainer').innerHTML = table;
            }
            logModal.style.display = 'flex';
        });
        
        document.getElementById('closeLogBtn').addEventListener('click', function() {
            logModal.style.display = 'none';
        });
        
        document.getElementById('exportPdfBtn').addEventListener('click', function() {
            loadJsPDF(() => exportSectionLogToPDF(currentSection));
        });
        
        function exportSectionLogToPDF(section) {
            const { jsPDF } = window.jspdf;
            const data = seatsData[section].map(seat => seat).filter(seat => seat.owner || seat.bookedAt || seat.leftAt);
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
            // خلفية ملونة
            doc.setFillColor(255, 215, 0);
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 60, 'F');
            // عنوان
            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text(`سجل كراسي القسم ${section}`, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            // رسم أيقونة كرسي
            doc.setDrawColor(80, 80, 80);
            doc.setFillColor(255, 180, 50);
            doc.ellipse(60, 45, 18, 12, 'FD');
            doc.setFillColor(255, 215, 0);
            doc.rect(50, 55, 20, 18, 'F');
            // رأس الجدول
            const headers = ['رقم الكرسي', 'الاسم', 'الموبايل', 'وقت الحجز', 'وقت الخروج'];
            const startY = 90;
            let y = startY;
            doc.setFontSize(13);
            doc.setTextColor(255,255,255);
            doc.setFillColor(65, 67, 69);
            doc.rect(40, y, 720, 28, 'F');
            headers.forEach((h, i) => {
                doc.text(h, 60 + i*140, y+19, { align: 'right' });
            });
            y += 32;
            // بيانات الجدول
            data.forEach((seat, idx) => {
                // صفوف ملونة بالتبادل
                if (idx % 2 === 0) doc.setFillColor(255, 243, 200);
                else doc.setFillColor(255, 255, 255);
                doc.rect(40, y-2, 720, 26, 'F');
                doc.setTextColor(40,40,40);
                doc.text(String(seat.number), 60, y+15, { align: 'right' });
                doc.text(seat.owner || '', 200, y+15, { align: 'right' });
                doc.text(seat.mobile || '', 340, y+15, { align: 'right' });
                doc.text(seat.bookedAt || '', 480, y+15, { align: 'right' });
                doc.text(seat.leftAt || '', 620, y+15, { align: 'right' });
                y += 28;
            });
            // تذييل
            doc.setFontSize(10);
            doc.setTextColor(120,120,120);
            doc.text('تم التصدير من نظام حجز كراسي مسرح الواي', doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 20, { align: 'center' });
            doc.save(`سجل-كراسي-القسم-${section}.pdf`);
        }
        
        // --- Admin Page ---
        function renderAdminCheckboxes() {
            const sectionsDiv = document.getElementById('adminSectionsCheckboxes');
            sectionsDiv.innerHTML = '<label style="font-size:1em;">الأقسام المسموح بها:</label>';
            ['A','B','C'].forEach(sec => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="section${sec}" value="${sec}"> ${sec}`;
                sectionsDiv.appendChild(label);
            });
            
            const permsDiv = document.getElementById('adminPermissionsCheckboxes');
            permsDiv.innerHTML = '<label style="font-size:1em;">الصلاحيات:</label>';
            PERMISSIONS.forEach(perm => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" id="perm_${perm.key}" value="${perm.key}"> ${perm.label}`;
                permsDiv.appendChild(label);
            });
        }
        
        function renderUsersTable() {
            let html = '<table class="seat-table">';
            html += '<tr><th>اسم المستخدم</th><th>الأقسام</th><th>الصلاحيات</th><th>حذف</th></tr>';
            Object.keys(USERS).forEach(u => {
                html += `<tr>
                    <td>${u}</td>
                    <td>`;
                ['A','B','C'].forEach(sec => {
                    const checked = USERS[u].section.includes(sec) ? 'checked' : '';
                    const disabled = u==='filo' ? 'disabled' : '';
                    html += `<label style='margin-left:8px;'><input type='checkbox' class='user-section-checkbox' data-user='${u}' value='${sec}' ${checked} ${disabled}> ${sec}</label>`;
                });
                html += `</td><td>`;
                PERMISSIONS.forEach(p => {
                    const checked = USERS[u].permissions && USERS[u].permissions.includes(p.key) ? 'checked' : '';
                    const disabled = u==='filo' && p.key==='admin' ? 'checked disabled' : (u==='filo' ? 'disabled' : '');
                    html += `<label style='margin-left:8px;'><input type='checkbox' class='user-perm-checkbox' data-user='${u}' value='${p.key}' ${checked} ${disabled}> ${p.label}</label>`;
                });
                html += `</td>
                    <td><button class='deleteUserBtn' data-user='${u}' ${u==='filo'?'disabled':''}>🗑️</button></td>
                </tr>`;
            });
            html += '</table>';
            document.getElementById('usersTableContainer').innerHTML = html;
            
            // حذف مستخدم
            document.querySelectorAll('.deleteUserBtn').forEach(btn => {
                btn.onclick = function() {
                    const user = this.getAttribute('data-user');
                    if(user==='filo') { alert('لا يمكن حذف الأدمن الرئيسي'); return; }
                    delete USERS[user];
                    renderUsersTable();
                };
            });
            
            // تعديل الأقسام المسموح بها
            document.querySelectorAll('.user-section-checkbox').forEach(chk => {
                chk.onchange = function() {
                    const user = this.getAttribute('data-user');
                    if(user==='filo') return;
                    const sec = this.value;
                    if(this.checked) {
                        if(!USERS[user].section.includes(sec)) USERS[user].section.push(sec);
                    } else {
                        USERS[user].section = USERS[user].section.filter(s => s!==sec);
                        if(USERS[user].section.length===0) {
                            alert('يجب أن يكون هناك قسم واحد على الأقل!');
                            this.checked = true;
                            USERS[user].section.push(sec);
                        }
                    }
                };
            });
            
            // تعديل الصلاحيات
            document.querySelectorAll('.user-perm-checkbox').forEach(chk => {
                chk.onchange = function() {
                    const user = this.getAttribute('data-user');
                    if(user==='filo' && this.value==='admin') return;
                    if(!USERS[user].permissions) USERS[user].permissions = [];
                    if(this.checked) {
                        if(!USERS[user].permissions.includes(this.value)) USERS[user].permissions.push(this.value);
                    } else {
                        USERS[user].permissions = USERS[user].permissions.filter(p => p!==this.value);
                    }
                };
            });
        }
        
        // إضافة مستخدم جديد
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const sections = [];
            if(document.querySelector('input[name="sectionA"]').checked) sections.push('A');
            if(document.querySelector('input[name="sectionB"]').checked) sections.push('B');
            if(document.querySelector('input[name="sectionC"]').checked) sections.push('C');
            // صلاحيات
            const permissions = [];
            PERMISSIONS.forEach(p => {
                if(document.getElementById('perm_'+p.key)?.checked) permissions.push(p.key);
            });
            if(!username || !password || sections.length===0) return;
            if(USERS[username]) { alert('اسم المستخدم موجود بالفعل'); return; }
            USERS[username] = { password, section: sections, permissions };
            renderUsersTable();
            this.reset();
        });
        
        // --- Inquiry Page ---
        document.getElementById('inquiryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const q = document.getElementById('inquiryInput').value.trim();
            const resultDiv = document.getElementById('inquiryResult');
            if (!q) { resultDiv.innerHTML = '<span style="color:#b00">يرجى إدخال رقم كرسي أو اسم أو موبايل</span>'; return; }
            let found = [];
            Object.keys(seatsData).forEach(section => {
                seatsData[section].forEach(seat => {
                    if (
                        seat.number.toString() === q ||
                        (seat.owner && seat.owner.includes(q)) ||
                        (seat.mobile && seat.mobile.includes(q))
                    ) {
                        found.push({ ...seat, section });
                    }
                });
            });
            if (found.length === 0) {
                resultDiv.innerHTML = '<span style="color:#b00">لا يوجد نتائج مطابقة</span>';
            } else {
                let html = '<table class="result-table">';
                html += '<tr><th>القسم</th><th>رقم الكرسي</th><th>الاسم</th><th>الموبايل</th><th>وقت الحجز</th><th>وقت الخروج</th></tr>';
                found.forEach(seat => {
                    html += `<tr>
                        <td>${seat.section}</td>
                        <td>${seat.number}</td>
                        <td>${seat.owner}</td>
                        <td>${seat.mobile}</td>
                        <td>${seat.bookedAt || ''}</td>
                        <td>${seat.leftAt || ''}</td>
                    </tr>`;
                });
                html += '</table>';
                resultDiv.innerHTML = html;
            }
        });
        
        // --- Tickets Page ---
        document.getElementById('ticketSection').addEventListener('change', function() {
            const section = this.value;
            const seatSelect = document.getElementById('ticketSeatNumber');
            seatSelect.innerHTML = '<option value="">اختر رقم الكرسي</option>';
            if (!section || !seatsData[section]) return;
            seatsData[section].forEach(seat => {
                if (!seat.owner) {
                    const opt = document.createElement('option');
                    opt.value = seat.number;
                    opt.textContent = seat.number;
                    seatSelect.appendChild(opt);
                }
            });
        });
        
        document.getElementById('sellTicketForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('ticketBuyerName').value.trim();
            const mobile = document.getElementById('ticketBuyerMobile').value.trim();
            const section = document.getElementById('ticketSection').value;
            const seatNumber = parseInt(document.getElementById('ticketSeatNumber').value, 10);
            if (!name || !mobile || !section || !seatNumber) return;
            // تحقق أن الكرسي مازال متاح
            const seat = seatsData[section][seatNumber - 1];
            if (seat.owner) {
                document.getElementById('ticketResult').innerHTML = '<span style="color:#b00">هذا الكرسي محجوز بالفعل</span>';
                return;
            }
            // حجز الكرسي فعليًا
            seat.owner = name;
            seat.mobile = mobile;
            seat.bookedAt = new Date().toLocaleString('ar-EG');
            seat.leftAt = '';
            // إضافة التذكرة للسجل
            const ticket = {
                serial: ticketSerial++,
                name,
                mobile,
                section,
                seatNumber,
                soldAt: new Date().toLocaleString('ar-EG')
            };
            soldTickets.push(ticket);
            document.getElementById('ticketResult').innerHTML = `<div style='color:#080; font-weight:bold;'>تم بيع التذكرة بنجاح<br>رقم التذكرة: ${ticket.serial}<br>رقم الكرسي: ${seatNumber}</div>`;
            // تحديث قائمة الكراسي
            const seatSelect = document.getElementById('ticketSeatNumber');
            seatSelect.querySelector(`option[value='${seatNumber}']`)?.remove();
        });
        
        // --- Attendance Page ---
        document.getElementById('attendanceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const q = document.getElementById('attendanceName').value.trim();
            if (!q) {
                document.getElementById('attendanceResult').innerHTML = '<span style="color:#b00">يرجى إدخال اسم أو رقم موبايل</span>';
                return;
            }
            // البحث في الكراسي والتذاكر
            let found = null;
            let type = '';
            Object.keys(seatsData).forEach(section => {
                seatsData[section].forEach(seat => {
                    if ((seat.owner && seat.owner.includes(q)) || (seat.mobile && seat.mobile.includes(q))) {
                        found = { name: seat.owner, mobile: seat.mobile, section, source: 'seat' };
                        type = 'seat';
                    }
                });
            });
            if (!found) {
                for (let t of soldTickets) {
                    if (t.name.includes(q) || t.mobile.includes(q)) {
                        found = { name: t.name, mobile: t.mobile, section: t.section, source: 'ticket' };
                        type = 'ticket';
                        break;
                    }
                }
            }
            if (!found) {
                document.getElementById('attendanceResult').innerHTML = '<span style="color:#b00">لم يتم العثور على الشخص</span>';
                return;
            }
            // تسجيل الدخول أو الانصراف
            let last = attendanceLog.length > 0 ? attendanceLog[attendanceLog.length-1] : null;
            let action = 'دخول';
            if (last && last.name === found.name && last.mobile === found.mobile && last.action === 'دخول') {
                action = 'انصراف';
            }
            attendanceLog.push({
                name: found.name,
                mobile: found.mobile,
                section: found.section,
                action,
                time: new Date().toLocaleString('ar-EG'),
                source: found.source
            });
            document.getElementById('attendanceResult').innerHTML = `<div style='color:#080; font-weight:bold;'>تم تسجيل ${action} بنجاح<br>الاسم: ${found.name}<br>الموبايل: ${found.mobile}<br>القسم: ${found.section}</div>`;
        });
        
        // --- Load jsPDF ---
        let jsPDFLoaded = false;
        function loadJsPDF(callback) {
            if (jsPDFLoaded) return callback();
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
            script.onload = function() { 
                jsPDFLoaded = true; 
                callback(); 
            };
            document.body.appendChild(script);
        }
        
        // Initialize
        showPage(loginPage);
    });
    </script>
</body>
</html>